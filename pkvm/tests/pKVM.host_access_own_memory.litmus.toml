arch = "AArch64"
name = "pKVM.host_access_own_memory"
symbolic = []

page_table_setup = """
option default_tables = false;

virtual x;
physical pa1;
intermediate ipa1 ipa2;

s1table vm1_stage1 0x2C0000 {
  x |-> ipa1;
}
s1table vm2_stage1 0x300000 {
  x |-> ipa2;
}
s2table vm1_stage2 0x240000 {
  ipa1 |-> invalid;
  s1table vm1_stage1;
}
s2table vm2_stage2 0x280000 {
  ipa1 |-> invalid;
  s1table vm2_stage1;
}
s1table hyp_map 0x200000 {
  x |-> invalid;
  s2table vm1_stage2;
  s2table vm2_stage2;
  identity 0x1000 with code;
  identity 0x2000 with code;
}
*pa1 = 0;
"""

[thread.0]
code = """
  MOV X0,#1
  STR X0,[X1]
  MOV X2,#0
  LDR X2,[X3]
"""

[section.thread0_el1_handler]
address = "0x1200" # 0x200 - Same Exception Level (SP_ELx)
code = """
  MRS X20,ELR_EL1
  ADD X20,X20,#4
  MSR ELR_EL1,X20
  ERET
"""

[section.thread0_el2_handler]
address = "0x2400" # 0x400 - Lower exception level
code = """
  MRS X20,ELR_EL2
  ADD X20,X20,#4
  MSR ELR_EL2,X20
  ERET
"""

[thread.0.reset]
R1 = "x"
R3 = "x"
TTBR0_EL2 = "ttbr(asid=0x00, base=hyp_map)"
VTTBR_EL2 = "ttbr(vmid=0x0001, base=vm1_stage2)"
TTBR0_EL1 = "ttbr(asid=0x00, base=vm1_stage1)"
VBAR_EL1 = "extz(0x1000, 64)"
VBAR_EL2 = "extz(0x2000, 64)"

"PSTATE.EL" = "0b01"
"PSTATE.SP" = "0b1"

[final]
assertion = "~0:X2=1"
arch = "AArch64"
name = "pKVM.host_unshare_hyp.concurrent"
symbolic = []

page_table_setup = """
option default_tables = false;

virtual x;
physical pa1;
intermediate ipa1 ipa2;

s1table host_stage1 0x2C0000 {
  x |-> ipa1;
}
s1table guest1_stage1 0x300000 {
  x |-> ipa2;
}
s2table host_stage2 0x240000 {
  ipa1 |-> pa1;
  s1table host_stage1;
}
s2table guest1_stage2 0x280000 {
  ipa1 |-> pa1;
  s1table guest1_stage1;
}
s1table hyp_map 0x200000 {
  identity 0x1000 with code;
  identity 0x2000 with code;
  identity 0x3000 with code;
  x |-> pa1;
  x ?-> invalid;
  s2table host_stage2;
  s2table guest1_stage2;
}
*pa1 = 0;
"""

[thread.0]
code = """
  // store to page to be unshared
  MOV X0,#1
  STR X0,[X1]
  // __pkvm_host_unshare_hyp
  HVC #0x0
  // store once unshared
  MOV X0,#2
  STR X0,[X1]
"""

[section.thread0_el1_handler]
address = "0x1200" # 0x200 - Same Exception Level (SP_ELx)
code = """
  MRS X20,ELR_EL1
  ADD X20,X20,#4
  MSR ELR_EL1,X20
  ERET
"""

[section.thread0_el2_handler_lower_exc]
address = "0x2400" # 0x400 - Lower Exception Level
code = """
  MRS X18,ELR_EL2
  MRS X19,SPSR_EL2
  STR X2,[X3] // pgtable.c:475 kvm_clear_pte(ptep);
  DSB ISHST // pgtable:476 dsb(ishst);
  TLBI VAE2IS,X6 // pgtable:477 __tlbi_level(vale2is, __TLBI_VADDR(addr, 0), level);
  DSB ISH // pgtable.c:481 dsb(ish);
  ISB // pgtable.c:482 isb();
  MSR ELR_EL2,X18
  MSR SPSR_EL2,X19
  ERET
"""

[section.thread0_el2_handler_same_exc]
address = "0x2200" # 0x200 - Same Exception Level (SP_ELx)
code = """
  MRS X20,ELR_EL2
  ADD X20,X20,#4
  MSR ELR_EL2,X20
  ERET
"""

[thread.0.reset]
R1 = "x"
R2 = "extz(0x0, 64)"
R3 = "pte3(x, hyp_map)"
R5 = "x"
R6 = "extz(page(x), 64)"
TTBR0_EL2 = "ttbr(asid=0x00, base=hyp_map)"
VTTBR_EL2 = "ttbr(vmid=0x0001, base=host_stage2)"
TTBR0_EL1 = "ttbr(asid=0x00, base=host_stage1)"
VBAR_EL2 = "extz(0x2000, 64)"

"PSTATE.EL" = "0b01"
"PSTATE.SP" = "0b1"

[thread.1]
code = """
  // concurrently, in pKVM...
  MOV X0,#0
  LDR X0,[X1]
"""

[thread.1.reset]
R1 = "x"
TTBR0_EL2 = "ttbr(asid=0x00, base=hyp_map)"
VTTBR_EL2 = "ttbr(vmid=0x0001, base=host_stage2)"
TTBR0_EL1 = "ttbr(asid=0x00, base=host_stage1)"
VBAR_EL2 = "extz(0x3000, 64)"
"PSTATE.EL" = "0b10"
"PSTATE.SP" = "0b1"

[section.thread1_el2_handler_same_exc]
address = "0x3200" # 0x200 - Same Exception Level (SP_ELx)
code = """
  MRS X20,ELR_EL2
  ADD X20,X20,#4
  MSR ELR_EL2,X20
  ERET
"""


[final]
assertion = "1:X0=2"